---
- name: Configure Power Management (Lid Switch & Sleep)
  hosts: all
  become: true
  tasks:
    - name: Ignore Lid Switch Events (logind.conf)
      ansible.builtin.lineinfile:
        path: /etc/systemd/logind.conf
        regexp: '^#?{{ item.key }}='
        line: '{{ item.key }}={{ item.value }}'
        state: present
        backup: yes
      loop:
        - { key: 'HandleLidSwitch', value: 'ignore' }
        - { key: 'HandleLidSwitchExternalPower', value: 'ignore' }
        - { key: 'HandleLidSwitchDocked', value: 'ignore' }
      notify: Restart systemd-logind

    - name: Mask Sleep and Suspend Targets
      ansible.builtin.systemd:
        name: '{{ item }}'
        masked: true
        enabled: false
      loop:
        - sleep.target
        - suspend.target
        - hibernate.target
        - hybrid-sleep.target

    - name: Disable Wi-Fi Power Save (NetworkManager)
      ansible.builtin.copy:
        dest: /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf
        content: |
          [connection]
          wifi.powersave = 2
        force: true
      notify: Restart NetworkManager

  handlers:
    - name: Restart systemd-logind
      ansible.builtin.service:
        name: systemd-logind
        state: restarted

    - name: Restart NetworkManager
      ansible.builtin.service:
        name: NetworkManager
        state: restarted
